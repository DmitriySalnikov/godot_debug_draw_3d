name: üõ†Ô∏è GDExtension Build
on:
  push:
    paths:
      [
        src/**,
        .github/**,
        "!.github/**/util_*",
        "patches/**",
        lib_utils.py,
        SConstruct,
      ]
  pull_request:
    paths:
      [
        src/**,
        .github/**,
        "!.github/**/util_*",
        "patches/**",
        lib_utils.py,
        SConstruct,
      ]
  workflow_dispatch:
    inputs:
      production_build:
        description: Production build
        default: true
        type: boolean
      use_cache:
        description: Use Cache
        default: true
        type: boolean

# Stop the same workflow actions
concurrency:
  group: ${{github.workflow}}-${{github.event.pull_request.number || github.ref}}-${{inputs.production_build}}
  cancel-in-progress: true

permissions:
  actions: write

env:
  SCONS_CACHE: ${{github.workspace}}/.scons-cache/
  USE_CACHE: ${{!format('{0}', inputs.use_cache) && 'true' || format('{0}', inputs.use_cache)}} # Default true
  PRODUCTION_BUILD: ${{!format('{0}', inputs.production_build) && 'false' || format('{0}', inputs.production_build)}} # Default false
  ENVIRONMENT_NAME: ${{inputs.production_build == 'true' && 'production' || ''}}
  OUTPUT_LIBS_PATH: bin
  FORCE_DISABLE_UNITY: yes
  NDK_VERSION: "28.1.13356709" # r28b
  EM_VERSION: 3.1.64

jobs:
  gen-api:
    name: üìù Native API Generation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Get library version
        id: get_version
        uses: ./.github/actions/get_lib_version
        with:
          print_summary: false

      - name: Configuring Python packages
        run: |
          python -m pip install scons
          python --version
          scons --version

      - name: Standard API
        run: scons gen_apis addon_output_dir=${{env.OUTPUT_LIBS_PATH}}/libs

      - name: Upload Standard API
        uses: actions/upload-artifact@v4
        with:
          name: .gdextension_native_api-${{steps.get_version.outputs.version}}
          retention-days: 7
          include-hidden-files: true
          path: |
            ${{env.OUTPUT_LIBS_PATH}}/native_api
            !${{env.OUTPUT_LIBS_PATH}}/native_api/*.json

      - name: Double API
        run: scons gen_apis precision=double addon_output_dir=${{env.OUTPUT_LIBS_PATH}}/libs

      - name: Upload Double API
        uses: actions/upload-artifact@v4
        with:
          name: .gdextension_native_api_double-${{steps.get_version.outputs.version}}
          retention-days: 7
          include-hidden-files: true
          path: |
            ${{env.OUTPUT_LIBS_PATH}}/native_api
            !${{env.OUTPUT_LIBS_PATH}}/native_api/*.json

  # ============================================

  editor-gdextension:
    name: "${{matrix.platform_name}}: ${{matrix.arch}}, ${{matrix.target}}"
    runs-on: ${{matrix.runner-os}}
    environment: ${{inputs.production_build == true && 'production' || ''}}
    env:
      TELEMETRY_DD3D_APP_ID: ${{secrets.TELEMETRY_DD3D_APP_ID}}
      TELEMETRY_DD3D_HOST: ${{secrets.TELEMETRY_DD3D_HOST}}
      TELEMETRY_DST_FILE_KEY: ${{secrets.TELEMETRY_DST_FILE_KEY}}

    strategy:
      fail-fast: false
      matrix:
        runner-os:
          [ubuntu-22.04, ubuntu-22.04-arm, windows-latest, macos-latest]
        target: [editor, template_release]
        include:
          # Linux
          - runner-os: ubuntu-22.04
            platform_name: üêß Linux
            platform: linux
            arch: x86_64
          - runner-os: ubuntu-22.04-arm
            platform_name: üêß Linux
            platform: linux
            arch: arm64
          # Windows
          - runner-os: windows-latest
            platform_name: üèÅ Windows
            platform: windows
            arch: x86_64
          # macOS
          - runner-os: macos-latest
            platform_name: üçè MacOS
            platform: macos
            arch: universal
            additional: macos_deployment_target=10.14

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compile GDExtension
        uses: ./.github/actions/compile_gdextension
        with:
          platform: ${{matrix.platform}}
          target: ${{matrix.target}}
          arch: ${{matrix.arch}}
          artifact: libdd3d-${{matrix.platform}}.${{matrix.target}}.${{matrix.arch}}
          additional: lto=full ${{matrix.additional}}
          build_cpp_tests: true
          output_libs_path: ${{env.OUTPUT_LIBS_PATH}}
          use_cache: ${{env.USE_CACHE}}

  # ============================================

  template-gdextension:
    name: "${{matrix.platform_name}}: ${{matrix.arch}}"
    runs-on: ${{matrix.runner-os}}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Android
          - runner-os: ubuntu-latest
            platform_name: ü§ñ Android
            platform: android
            arch: arm32
            additional: ANDROID_HOME=""
            forced_dd3d: false
          - runner-os: ubuntu-latest
            platform_name: ü§ñ Android
            platform: android
            arch: arm64
            additional: ANDROID_HOME=""
            forced_dd3d: false
          - runner-os: ubuntu-latest
            platform_name: ü§ñ Android
            platform: android
            arch: x86_32
            additional: ANDROID_HOME=""
            forced_dd3d: false
          - runner-os: ubuntu-latest
            platform_name: ü§ñ Android
            platform: android
            arch: x86_64
            additional: ANDROID_HOME=""
            forced_dd3d: false
          # iOS
          - runner-os: macos-latest
            platform_name: üçè iOS
            platform: ios
            arch: universal
          # Web
          - runner-os: ubuntu-latest
            platform_name: üï∏ Web
            platform: web
            arch: wasm32
            additional: threads=yes
            suffix: .threads_yes
          - runner-os: ubuntu-latest
            platform_name: üï∏ Web threads=no
            platform: web
            arch: wasm32
            additional: threads=no
            suffix: .threads_no

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup NDK
        id: setup_ndk
        if: matrix.platform == 'android'
        uses: ./.github/actions/setup_ndk
        with:
          ndk_version: ${{env.NDK_VERSION}}

      - name: Setup Emscripten
        uses: pyodide/setup-emsdk@v15
        if: matrix.platform == 'web'
        continue-on-error: true
        with:
          version: ${{env.EM_VERSION}}
          actions-cache-folder: obj/emsdk_cache

      - name: Compile GDExtension target=template_debug
        uses: ./.github/actions/compile_gdextension
        env:
          ANDROID_NDK_ROOT: ${{steps.setup_ndk.outputs.ndk_path}}
        with:
          platform: ${{matrix.platform}}
          target: template_debug
          arch: ${{matrix.arch}}
          artifact: libdd3d-${{matrix.platform}}.template_debug.${{matrix.arch}}${{matrix.suffix}}
          additional: lto=full ${{matrix.additional}}
          output_libs_path: ${{env.OUTPUT_LIBS_PATH}}
          use_cache: ${{env.USE_CACHE}}

      - name: Compile GDExtension target=template_release
        uses: ./.github/actions/compile_gdextension
        env:
          ANDROID_NDK_ROOT: ${{steps.setup_ndk.outputs.ndk_path}}
        with:
          platform: ${{matrix.platform}}
          target: template_release
          arch: ${{matrix.arch}}
          artifact: libdd3d-${{matrix.platform}}.template_release.${{matrix.arch}}${{matrix.suffix}}
          additional: lto=full ${{matrix.additional}}
          build_forced_dd3d: ${{!format('{0}', matrix.forced_dd3d) && 'true' || format('{0}', matrix.forced_dd3d)}} # Default true
          build_cpp_tests: true
          output_libs_path: ${{env.OUTPUT_LIBS_PATH}}
          use_cache: ${{env.USE_CACHE}}

  # ============================================

  double-debug-gdextension:
    name: "2Ô∏è‚É£ Double: ${{matrix.runner-os}}, ${{matrix.platform}}"
    runs-on: ${{matrix.runner-os}}
    environment: ${{inputs.production_build == true && 'production' || ''}}
    env:
      TELEMETRY_DD3D_APP_ID: ${{secrets.TELEMETRY_DD3D_APP_ID}}
      TELEMETRY_DD3D_HOST: ${{secrets.TELEMETRY_DD3D_HOST}}
      TELEMETRY_DST_FILE_KEY: ${{secrets.TELEMETRY_DST_FILE_KEY}}

    strategy:
      fail-fast: false
      matrix:
        # sync with other jobs
        runner-os:
          [ubuntu-22.04, ubuntu-22.04-arm, macos-latest, windows-latest]
        include:
          - runner-os: ubuntu-22.04
            platform: linux
            arch: x86_64
          - runner-os: ubuntu-22.04-arm
            platform: linux
            arch: arm64
          - runner-os: macos-latest
            platform: macos
            arch: universal
          - runner-os: windows-latest
            platform: windows
            arch: "x86_64"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compile GDExtension target=editor
        uses: ./.github/actions/compile_gdextension
        with:
          platform: ${{matrix.platform}}
          target: editor
          arch: ${{matrix.arch}}
          artifact: libdouble-${{matrix.platform}}.editor.${{matrix.arch}}
          additional: lto=full precision=double fix_precision_enabled=yes shader_world_coords_enabled=no custom_api_file=patches/extension_api_double.json
          output_libs_path: ${{env.OUTPUT_LIBS_PATH}}
          use_cache: ${{env.USE_CACHE}}

      - name: Compile GDExtension target=template_release
        uses: ./.github/actions/compile_gdextension
        with:
          platform: ${{matrix.platform}}
          target: template_release
          arch: ${{matrix.arch}}
          artifact: libdouble-${{matrix.platform}}.template_release.${{matrix.arch}}
          additional: lto=full precision=double fix_precision_enabled=yes shader_world_coords_enabled=no custom_api_file=patches/extension_api_double.json
          output_libs_path: ${{env.OUTPUT_LIBS_PATH}}
          use_cache: ${{env.USE_CACHE}}

  # ============================================

  check-python-version:
    name: üêç Check compatibility with python
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        PYTHON_VER:
          ["3.8"] # this is the minimum available version to install on ubuntu 22.04 and 24.04
          # but the code is most likely compatible with python 3.6
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .
            patches

      - name: Setup python ${{matrix.PYTHON_VER}}
        uses: actions/setup-python@v5
        with:
          python-version: ${{matrix.PYTHON_VER}}

      - name: Try to compile all .py files
        run: |
          python --version
          files="SConstruct $(find . -maxdepth 1 -name "*.py") $(find patches -name "*.py")"
          echo "Found files: '$files'"
          python -m py_compile $files
          echo "All files compiled successfully!"

  # ============================================

  collect-gdextension:
    needs: [editor-gdextension, template-gdextension]
    name: üì¶ Collect GDExtension binaries
    runs-on: ubuntu-24.04
    outputs:
      libs_artifact: ${{steps.output_info.outputs.libs_artifact}}
      napi_artifact: ${{steps.output_info.outputs.napi_artifact}}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get library version
        id: get_version
        uses: ./.github/actions/get_lib_version

      - name: Download Binaries
        uses: actions/download-artifact@v4
        with:
          pattern: libdd3d-*
          path: extracted_files

      - name: Store all libraries in one directory
        run: |
          arch_dirs=$(find extracted_files/ -mindepth 1 -maxdepth 1 -type d)
          echo "Original structure:"
          find extracted_files -mindepth 1
          mv -f extracted_files/**/* extracted_files
          rm -rf $arch_dirs
          echo "Final structure:"
          find extracted_files -mindepth 1
          touch extracted_files/.gdignore

      - name: Output file information
        id: output_info
        run: |
          cd extracted_files
          echo "Total size: $(du -ch -b | grep total | cut -f1 | awk '{printf "%.2f", $1/1048576}') MB, Total number of files: $(find . -type f | wc -l)" >> $GITHUB_STEP_SUMMARY

          echo "libs_artifact=${{env.PRODUCTION_BUILD == 'true' && '.gdextension_libs_production' || '.gdextension_libs'}}-${{steps.get_version.outputs.version}}" >> $GITHUB_OUTPUT
          echo "napi_artifact=.gdextension_native_api-${{steps.get_version.outputs.version}}" >> $GITHUB_OUTPUT

      - name: Upload GDExtension
        uses: actions/upload-artifact@v4
        with:
          name: ${{steps.output_info.outputs.libs_artifact}}
          retention-days: 7
          include-hidden-files: true
          path: extracted_files/*

  # ============================================

  test_api_integration:
    name: "üß™ Testing API: ${{matrix.runner-os}}, Godot-${{matrix.file_suffix}}"
    runs-on: ${{matrix.runner-os}}
    needs: collect-gdextension

    strategy:
      fail-fast: false
      matrix:
        # sync with other jobs
        runner-os:
          [ubuntu-22.04, ubuntu-22.04-arm, macos-latest, windows-latest]
        include:
          - runner-os: ubuntu-22.04
            file_suffix: "linux.x86_64.zip"
          - runner-os: ubuntu-22.04-arm
            file_suffix: "linux.arm64.zip"
          - runner-os: macos-latest
            file_suffix: "macos.universal.zip"
          - runner-os: windows-latest
            file_suffix: "win64.zip" # non-mono version: win64.exe.zip

    env:
      ADDON_DIR: debug_draw_3d
      PROJECT_PATH: dd3d_web_build
      TESTS_PATH: examples_dd3d

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Delete old libs folder
        shell: bash
        run: |
          rm -rf addons/${{env.ADDON_DIR}}/libs

      - name: Download Binaries
        uses: actions/download-artifact@v4
        with:
          path: addons/${{env.ADDON_DIR}}/libs
          name: ${{needs.collect-gdextension.outputs.libs_artifact}}

      - name: Download Native Bindings
        uses: actions/download-artifact@v4
        with:
          path: addons/${{env.ADDON_DIR}}/native_api
          name: ${{needs.collect-gdextension.outputs.napi_artifact}}

      - name: Prepare Test Project
        shell: bash
        run: |
          cp -r addons ${{env.PROJECT_PATH}}/addons
          cp -r ${{env.TESTS_PATH}} ${{env.PROJECT_PATH}}/${{env.TESTS_PATH}}
          find ${{env.PROJECT_PATH}} -mindepth 1

      - name: Setup Godot 4.4.1
        uses: ./.github/actions/setup_godot
        id: setup_godot_4_4_1
        with:
          tag: 4.4.1-stable
          file_suffix: ${{matrix.file_suffix}}
          download_export_templates: false
          is_mono: true

      - name: Setup Godot 4.5
        uses: ./.github/actions/setup_godot
        id: setup_godot_4_5
        with:
          tag: 4.5-stable
          file_suffix: ${{matrix.file_suffix}}
          download_export_templates: false
          is_mono: true

      - name: Setup Godot 4.6
        uses: ./.github/actions/setup_godot
        id: setup_godot_4_6
        with:
          tag: 4.6-stable
          file_suffix: ${{matrix.file_suffix}}
          download_export_templates: false
          is_mono: true
          pre_release: false

      - name: macOS dependencies
        shell: bash
        if: runner.os == 'macOS'
        run: |
          brew install coreutils
          alias timeout="gtimeout"

      - name: Test runs
        shell: bash --noprofile --norc -o pipefail {0}
        run: |
          run_tests() {
            godot_exe="$1"
            echo "::group::üß™Testing '$godot_exe'"

            max_attempts=3
            current_attempt=1
            last_exit_code=0

            # Cleanup
            rm -f "${{env.PROJECT_PATH}}/SUCCESS"
            rm -rf "${{env.PROJECT_PATH}}/.godot"

            until [ $current_attempt -gt $max_attempts ]; do
              current_attempt=$((current_attempt + 1))
              echo "============================================="
              echo "üõí Project preparation"
              echo "============================================="
              timeout 2m $godot_exe -v -e --headless --path ${{env.PROJECT_PATH}} --quit || true

              echo "============================================="
              echo "üèóÔ∏è Build solutions"
              echo "============================================="
              timeout 2m $godot_exe -v -e --headless --path ${{env.PROJECT_PATH}} --build-solutions --quit || true

              echo "============================================="
              echo "‚úÖ --check-only test without MainLoop"
              echo "============================================="
              timeout 2m $godot_exe -v --headless --path ${{env.PROJECT_PATH}} --check-only --script res://check-only_test.gd
              if [ $? -ne 0 ]; then
                echo "[$godot_exe] The test without MainLoop failed. Exiting."
                exit 1
              fi

              echo "============================================="
              echo "üß™ Actual testing"
              echo "============================================="
              timeout 2m $godot_exe -v --headless --path ${{env.PROJECT_PATH}} res://headless_test.tscn || true

              if [ ! -f "${{env.PROJECT_PATH}}/SUCCESS" ]; then
                echo "[$godot_exe] The file reporting success has not been created! Failed."
                last_exit_code=1
              else
                echo "[$godot_exe] The file reporting success has been created! Success!"
                return 0
              fi
            done

            echo "[$godot_exe] The maximum number of attempts has been reached. Last error code: $?"
            exit $last_exit_code
          }

          run_tests "${{steps.setup_godot_4_4_1.outputs.godot}}"
          echo "::endgroup::"
          run_tests "${{steps.setup_godot_4_5.outputs.godot}}"
          echo "::endgroup::"
          run_tests "${{steps.setup_godot_4_6.outputs.godot}}"
          echo "::endgroup::"
